<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>港湾AI自動検査システム v5</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* スキャン演出 */
        .scanner-line {
            position: absolute;
            width: 100%; height: 4px;
            background: #eab308;
            box-shadow: 0 0 15px #eab308;
            animation: scan 1.5s linear infinite;
            top: 0; opacity: 0;
        }
        @keyframes scan { 0% { top: 0; opacity: 0; } 20% { opacity: 1; } 80% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .flash-effect { animation: flash 0.1s ease-out; }
        @keyframes flash { from { background: white; opacity: 0.8; } to { background: transparent; opacity: 0; } }
        /* 安全領域 */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gray-900 h-screen flex flex-col overflow-hidden font-sans select-none">

    <div id="top-panel" class="h-[30%] bg-white flex flex-col relative z-20 shadow-lg transition-colors duration-500">
        
        <div class="absolute top-2 left-3 flex gap-2 z-30">
            <div id="ble-badge" class="px-2 py-0.5 rounded text-[10px] font-bold border flex items-center gap-1 bg-white/90 text-blue-600 border-blue-200 transition-all">
                <span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span> BLE: CONNECTED
            </div>
        </div>

        <div id="view-process" class="flex-1 flex flex-col items-center justify-center p-4">
            <div class="text-center mt-4">
                <h1 id="main-status" class="text-2xl font-black text-gray-800 tracking-tight">WAITING SIGNAL</h1>
                <p id="sub-status" class="text-xs text-gray-400 font-bold mt-1">PLEASE RELEASE BRAKE (J1939)</p>
            </div>

            <button id="btn-trigger" class="mt-4 bg-slate-800 hover:bg-slate-700 text-white text-sm font-bold py-3 px-8 rounded-full shadow-lg active:scale-95 transition-transform flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                SIMULATE CAN SIGNAL
            </button>
        </div>

        <div id="view-result" class="hidden absolute inset-0 flex flex-col items-center justify-center p-2 animate-fade-in">
            <div class="flex items-center gap-3">
                <span id="res-icon" class="text-5xl bg-white/20 rounded-full p-2">✅</span>
                <div class="text-left">
                    <div id="res-title" class="text-5xl font-black text-white tracking-tighter leading-none">OK</div>
                    <div id="res-desc" class="text-xs text-white/80 font-bold uppercase tracking-widest">Inspection Passed</div>
                </div>
            </div>
            <button id="btn-confirm" class="mt-3 bg-white text-gray-900 font-black py-2 px-10 rounded-full shadow-lg active:scale-95 transition-transform text-sm border-b-4 border-gray-300 active:border-b-0 active:translate-y-0.5">
                CONFIRM & NEXT
            </button>
        </div>
    </div>

    <div class="h-[70%] relative bg-black overflow-hidden group">
        <video id="webcam" class="absolute inset-0 w-full h-full object-cover opacity-80" autoplay playsinline muted></video>
        <canvas id="overlay" class="absolute inset-0 w-full h-full object-cover"></canvas>
        
        <div id="scan-bar" class="scanner-line"></div>
        <div id="shutter-overlay" class="absolute inset-0 pointer-events-none"></div>

        <div class="absolute inset-0 flex items-center justify-center opacity-30 pointer-events-none">
            <div class="w-16 h-16 border-2 border-white/50 rounded-lg"></div>
            <div class="absolute w-1 h-4 bg-white/50"></div>
            <div class="absolute w-4 h-1 bg-white/50"></div>
        </div>

        <div id="photo-container" class="absolute bottom-0 left-0 right-0 h-24 bg-gradient-to-t from-black/90 to-transparent p-2 pb-safe flex gap-2 overflow-x-auto items-end opacity-50 transition-opacity duration-300">
            <div class="text-[9px] text-gray-500 font-mono w-full text-center mb-2">CAPTURED IMAGES WILL APPEAR HERE</div>
        </div>
    </div>

    <script>
        // --- 要素取得 ---
        const topPanel = document.getElementById('top-panel');
        const viewProcess = document.getElementById('view-process');
        const viewResult = document.getElementById('view-result');
        const mainStatus = document.getElementById('main-status');
        const subStatus = document.getElementById('sub-status');
        const btnTrigger = document.getElementById('btn-trigger');
        const btnConfirm = document.getElementById('btn-confirm');
        const bleBadge = document.getElementById('ble-badge');
        
        const resTitle = document.getElementById('res-title');
        const resIcon = document.getElementById('res-icon');
        
        const video = document.getElementById('webcam');
        const overlay = document.getElementById('overlay');
        const scanBar = document.getElementById('scan-bar');
        const shutterOverlay = document.getElementById('shutter-overlay');
        const photoContainer = document.getElementById('photo-container');

        // --- 変数 ---
        let model;
        let isModeActive = false; // 撮影待機モードかどうか
        let isCapturing = false;  // 連写中かどうか

        // --- 初期化 ---
        async function init() {
            mainStatus.innerText = "LOADING AI...";
            subStatus.innerText = "INITIALIZING COCO-SSD MODEL";
            btnTrigger.disabled = true;
            btnTrigger.classList.add('opacity-50');

            // 1. モデルロード
            model = await cocoSsd.load();
            
            // 2. カメラロード
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" },
                audio: false
            });
            video.srcObject = stream;
            
            video.onloadedmetadata = () => {
                mainStatus.innerText = "WAITING SIGNAL";
                subStatus.innerText = "READY TO RECEIVE J1939";
                btnTrigger.disabled = false;
                btnTrigger.classList.remove('opacity-50');
                detectFrame();
            };
        }

        // --- ① トリガーボタン (CAN信号受信) ---
        btnTrigger.addEventListener('click', () => {
            isModeActive = true;
            
            // UI更新: スタンバイモードへ
            btnTrigger.style.display = 'none';
            mainStatus.innerText = "SCANNING...";
            mainStatus.className = "text-3xl font-black text-blue-600 animate-pulse tracking-tight";
            subStatus.innerText = "DETECTING OBJECT TO AUTO-CAPTURE";
            
            // ★BLE切断シミュレーション
            bleBadge.className = "px-2 py-0.5 rounded text-[10px] font-bold border flex items-center gap-1 bg-gray-200 text-gray-500 border-gray-300";
            bleBadge.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-gray-400"></span> BLE: DISCONNECTED (STANDALONE)';
            
            // カメラUI更新
            scanBar.style.opacity = "1";
            video.classList.remove('opacity-80'); // 明るくする
            photoContainer.classList.remove('opacity-50');
            photoContainer.innerHTML = ''; // 写真クリア
        });

        // --- 物体検出ループ ---
        async function detectFrame() {
            if (!video.videoWidth) { requestAnimationFrame(detectFrame); return; }
            
            overlay.width = video.videoWidth; 
            overlay.height = video.videoHeight;
            const ctx = overlay.getContext('2d');
            const predictions = await model.detect(video);
            
            ctx.clearRect(0, 0, overlay.width, overlay.height);

            // 待機モード(isModeActive) かつ 撮影中でない場合
            if (isModeActive && !isCapturing) {
                if (predictions.length > 0) {
                    const best = predictions[0];

                    // 検出枠描画
                    ctx.strokeStyle = "#2563eb"; // Blue
                    ctx.lineWidth = 4;
                    ctx.strokeRect(...best.bbox);
                    
                    // ラベル
                    ctx.fillStyle = "#2563eb";
                    ctx.font = "bold 16px sans-serif";
                    ctx.fillText(best.class.toUpperCase(), best.bbox[0], best.bbox[1] - 10);

                    // 確信度60%超えで連写開始
                    if (best.score > 0.6) {
                        isModeActive = false; // 重複防止
                        startBurstCapture();
                    }
                }
            }
            requestAnimationFrame(detectFrame);
        }

        // --- 連写処理 ---
        async function startBurstCapture() {
            isCapturing = true;
            mainStatus.innerText = "CAPTURING...";
            mainStatus.className = "text-3xl font-black text-red-500 tracking-tight";
            subStatus.innerText = "TAKING 10 FRAMES FOR ANALYSIS";
            scanBar.style.animationDuration = "0.1s"; // 高速化

            for (let i = 0; i < 10; i++) {
                // シャッター
                shutterOverlay.classList.remove('flash-effect');
                void shutterOverlay.offsetWidth;
                shutterOverlay.classList.add('flash-effect');
                
                // 画像追加
                addThumbnail(i);
                
                await new Promise(r => setTimeout(r, 100)); // 0.1秒間隔
            }

            // 解析中
            mainStatus.innerText = "ANALYZING...";
            mainStatus.className = "text-3xl font-black text-gray-800 tracking-tight";
            subStatus.innerText = "AI VERIFYING IMAGES";
            scanBar.style.opacity = "0";

            setTimeout(showResult, 1000);
        }

        function addThumbnail(i) {
            const cvs = document.createElement('canvas');
            cvs.width = 160; cvs.height = 120;
            cvs.getContext('2d').drawImage(video, 0, 0, 160, 120);
            
            const img = document.createElement('img');
            img.src = cvs.toDataURL('image/jpeg');
            img.className = "h-full w-24 object-cover rounded border border-white/50 shadow-sm";
            
            photoContainer.insertBefore(img, photoContainer.firstChild);
        }

        // --- ② 結果表示 ---
        function showResult() {
            isCapturing = false;
            viewProcess.classList.add('hidden');
            viewResult.classList.remove('hidden');

            const isOk = Math.random() > 0.3; // デモ用判定

            if (isOk) {
                // OK: 緑背景
                topPanel.className = "h-[30%] bg-green-500 flex flex-col relative z-20 shadow-lg transition-colors duration-500";
                resTitle.innerText = "OK";
                resIcon.innerText = "✅";
                resIcon.className = "text-5xl bg-white/20 rounded-full p-2 grayscale-0";
                btnConfirm.className = "mt-3 bg-white text-green-700 font-black py-2 px-10 rounded-full shadow-lg active:scale-95 transition-transform text-sm border-b-4 border-green-800 active:border-b-0 active:translate-y-0.5";
            } else {
                // NG: 黄色背景
                topPanel.className = "h-[30%] bg-yellow-400 flex flex-col relative z-20 shadow-lg transition-colors duration-500";
                resTitle.innerText = "NG";
                resIcon.innerText = "⚠️";
                resIcon.className = "text-5xl bg-black/10 rounded-full p-2 grayscale-0";
                // NG時は文字色を黒っぽく
                document.getElementById('res-title').classList.add('text-gray-900');
                document.getElementById('res-desc').classList.replace('text-white/80', 'text-gray-800/80');
                
                btnConfirm.className = "mt-3 bg-gray-900 text-yellow-400 font-black py-2 px-10 rounded-full shadow-lg active:scale-95 transition-transform text-sm border-b-4 border-black active:border-b-0 active:translate-y-0.5";
            }
        }

        // --- ③ 確認ボタン (リセット) ---
        btnConfirm.addEventListener('click', () => {
            // UIリセット
            topPanel.className = "h-[30%] bg-white flex flex-col relative z-20 shadow-lg transition-colors duration-500";
            viewResult.classList.add('hidden');
            viewProcess.classList.remove('hidden');
            
            // BLE接続復帰 (シミュレーション)
            bleBadge.className = "px-2 py-0.5 rounded text-[10px] font-bold border flex items-center gap-1 bg-white/90 text-blue-600 border-blue-200 transition-all";
            bleBadge.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span> BLE: CONNECTED';

            mainStatus.innerText = "WAITING SIGNAL";
            mainStatus.className = "text-2xl font-black text-gray-800 tracking-tight";
            subStatus.innerText = "READY TO RECEIVE J1939";
            
            btnTrigger.style.display = 'flex';
            video.classList.add('opacity-80');
            photoContainer.classList.add('opacity-50');
            photoContainer.innerHTML = '<div class="text-[9px] text-gray-500 font-mono w-full text-center mb-2">CAPTURED IMAGES WILL APPEAR HERE</div>';
            
            // 文字色リセット(NG時の変更を戻す)
            document.getElementById('res-title').classList.remove('text-gray-900');
            document.getElementById('res-desc').classList.replace('text-gray-800/80', 'text-white/80');
        });

        init();
    </script>
</body>
</html>
