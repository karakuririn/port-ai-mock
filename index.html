<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>港湾AI自動検査システム</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* カメラのスキャン演出 */
        .scanner-line {
            position: absolute;
            width: 100%; height: 4px;
            background: #eab308;
            box-shadow: 0 0 10px #eab308;
            animation: scan 1.5s linear infinite;
            top: 0; opacity: 0; /* 最初は隠す */
        }
        @keyframes scan { 0% { top: 0; opacity: 0; } 20% { opacity: 1; } 80% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        /* シャッターフラッシュ */
        .flash-effect { animation: flash 0.1s ease-out; }
        @keyframes flash { from { background: white; opacity: 0.8; } to { background: transparent; opacity: 0; } }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col overflow-hidden font-sans">

    <div class="relative flex-grow h-[60%] bg-black overflow-hidden border-b-4 border-yellow-600">
        <video id="webcam" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>
        <canvas id="overlay" class="absolute inset-0 w-full h-full object-cover"></canvas>
        
        <div id="scan-bar" class="scanner-line"></div>
        <div id="shutter-overlay" class="absolute inset-0 pointer-events-none"></div>

        <div class="absolute top-4 left-4 bg-black/70 px-3 py-1 rounded text-xs font-mono border border-yellow-500/50 flex gap-2 items-center">
            <span id="cam-status" class="text-gray-500">● CAMERA READY</span>
        </div>
    </div>

    <div class="h-[40%] bg-gray-800 flex flex-col p-4 shadow-[0_-5px_15px_rgba(0,0,0,0.5)] z-10 relative">
        
        <div class="flex justify-between items-center mb-2 border-b border-gray-600 pb-2">
            <div class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">System Status</div>
            <div id="can-indicator" class="text-[10px] font-mono text-red-400 flex items-center gap-1 transition-colors duration-300">
                <span class="w-2 h-2 rounded-full bg-red-500"></span> WAITING FOR CAN
            </div>
        </div>

        <div class="flex-1 relative">
            
            <div id="view-process" class="absolute inset-0 flex flex-col justify-between transition-opacity duration-300">
                <div class="flex-1 flex items-center justify-center">
                    <p id="instruction-text" class="text-center text-gray-400 text-sm font-bold animate-pulse">
                        Push CAN Button to Start
                    </p>
                </div>

                <div id="photo-strip" class="h-20 flex gap-2 overflow-x-auto items-center py-2 px-1 hidden">
                    </div>

                <button id="btn-can-signal" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-xl shadow-lg border-b-4 border-blue-800 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    [①] GET CAN SIGNAL
                </button>
            </div>

            <div id="view-result" class="absolute inset-0 bg-gray-800 flex flex-col items-center justify-center hidden opacity-0 transition-opacity duration-300">
                <div id="judge-icon" class="text-6xl mb-2 scale-0 transition-transform duration-500">✅</div>
                <div id="judge-title" class="text-4xl font-black text-green-500 tracking-tighter">OK</div>
                <div id="judge-desc" class="text-sm text-gray-400 mt-1 mb-6">Inspection Completed</div>
                
                <button id="btn-confirm" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-md border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition-all">
                    [②] CONFIRM & NEXT
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 要素の取得 ---
        const video = document.getElementById('webcam');
        const overlay = document.getElementById('overlay');
        const shutterOverlay = document.getElementById('shutter-overlay');
        const scanBar = document.getElementById('scan-bar');
        const camStatus = document.getElementById('cam-status');
        const canIndicator = document.getElementById('can-indicator');
        const instruction = document.getElementById('instruction-text');
        const photoStrip = document.getElementById('photo-strip');
        
        // ボタン類
        const btnCanSignal = document.getElementById('btn-can-signal'); // ①
        const btnConfirm = document.getElementById('btn-confirm');     // ②
        
        // 画面切り替え用
        const viewProcess = document.getElementById('view-process');
        const viewResult = document.getElementById('view-result');
        const judgeTitle = document.getElementById('judge-title');
        const judgeIcon = document.getElementById('judge-icon');
        const judgeDesc = document.getElementById('judge-desc');

        // 変数
        let model;
        let isSystemActive = false; // CAN信号を受信してアクティブかどうか
        let isCapturing = false;    // 撮影中かどうか

        // --- 初期化処理 ---
        async function init() {
            instruction.innerText = "Loading AI Model...";
            btnCanSignal.disabled = true;
            btnCanSignal.classList.add('opacity-50');

            // 1. モデルロード
            model = await cocoSsd.load();
            
            // 2. カメラ起動
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" },
                audio: false
            });
            video.srcObject = stream;
            
            video.onloadedmetadata = () => {
                instruction.innerText = "System Ready. Please Get Signal.";
                btnCanSignal.disabled = false;
                btnCanSignal.classList.remove('opacity-50');
                detectFrame(); // 検出ループ開始
            };
        }

        // --- ① CAN信号取得ボタンクリック時 ---
        btnCanSignal.addEventListener('click', () => {
            isSystemActive = true;
            
            // UI更新
            btnCanSignal.style.display = 'none'; // ボタンを隠す
            canIndicator.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 animate-ping"></span> J1939 SIGNAL: ON';
            canIndicator.className = "text-[10px] font-mono text-green-400 flex items-center gap-1";
            
            instruction.innerText = "Targeting Object...";
            instruction.className = "text-center text-xl font-black text-yellow-500 animate-pulse";
            
            scanBar.style.opacity = "1"; // スキャンアニメーション開始
            camStatus.innerHTML = '<span class="text-yellow-400">● SCANNING...</span>';
            photoStrip.classList.remove('hidden'); // 写真エリア表示
            photoStrip.innerHTML = ''; // 写真クリア
        });

        // --- 物体検出ループ ---
        async function detectFrame() {
            if (!video.videoWidth) {
                requestAnimationFrame(detectFrame);
                return;
            }

            // キャンバス設定
            overlay.width = video.videoWidth;
            overlay.height = video.videoHeight;
            const ctx = overlay.getContext('2d');

            // 常に推論は回しておく（待機中でもカメラ映像は見えているため）
            const predictions = await model.detect(video);
            ctx.clearRect(0, 0, overlay.width, overlay.height);

            // 信号受信中(isSystemActive) かつ 撮影中でない場合のみ、判定ロジックが走る
            if (isSystemActive && !isCapturing) {
                // デモ用に検出しやすい物体（person, cup, cell phone等）に反応
                if (predictions.length > 0) {
                    const best = predictions[0];
                    
                    // 描画
                    ctx.strokeStyle = "#00FF00";
                    ctx.lineWidth = 4;
                    ctx.strokeRect(...best.bbox);
                    
                    ctx.fillStyle = "#00FF00";
                    ctx.font = "bold 16px Arial";
                    ctx.fillText(best.class.toUpperCase(), best.bbox[0], best.bbox[1] - 10);

                    // 確信度が60%超えたら連写開始
                    if (best.score > 0.6) {
                        isSystemActive = false; // 二重トリガー防止
                        startBurstCapture();
                    }
                }
            }
            requestAnimationFrame(detectFrame);
        }

        // --- 10連写処理 ---
        async function startBurstCapture() {
            isCapturing = true;
            instruction.innerText = "AUTO CAPTURING...";
            instruction.className = "text-center text-lg font-bold text-red-500";
            
            // 演出高速化
            scanBar.style.animationDuration = "0.1s";

            for (let i = 0; i < 10; i++) {
                // シャッター音（視覚効果）
                shutterOverlay.classList.remove('flash-effect');
                void shutterOverlay.offsetWidth;
                shutterOverlay.classList.add('flash-effect');

                // キャプチャ保存
                captureFrame(i);

                // 待機 (0.1秒)
                await new Promise(r => setTimeout(r, 100));
            }

            // 撮影完了 -> 解析演出
            instruction.innerText = "ANALYZING...";
            scanBar.style.opacity = "0"; // スキャン停止
            
            setTimeout(showResult, 1500); // 1.5秒後に結果表示
        }

        // フレーム切り出し処理
        function captureFrame(index) {
            const canvas = document.createElement('canvas');
            canvas.width = 160; canvas.height = 120;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const div = document.createElement('div');
            div.className = "flex-shrink-0 w-20 h-14 border-2 border-yellow-500 rounded overflow-hidden relative shadow-sm";
            const img = document.createElement('img');
            img.src = canvas.toDataURL('image/jpeg');
            img.className = "w-full h-full object-cover";
            
            const badge = document.createElement('div');
            badge.className = "absolute bottom-0 right-0 bg-black/70 text-white text-[8px] px-1";
            badge.innerText = "#" + (index + 1);

            div.appendChild(img);
            div.appendChild(badge);
            photoStrip.insertBefore(div, photoStrip.firstChild); // 最新を左に
        }

        // --- 結果表示 ---
        function showResult() {
            isCapturing = false;
            
            // 画面切り替え（フェードイン）
            viewResult.classList.remove('hidden');
            // 少し遅らせてopacityを変えることでアニメーションさせる
            setTimeout(() => {
                viewResult.classList.remove('opacity-0');
                document.getElementById('judge-icon').classList.remove('scale-0');
            }, 50);

            // ランダム判定 (20% NG)
            const isOk = Math.random() > 0.2;

            if (isOk) {
                judgeTitle.innerText = "OK";
                judgeTitle.className = "text-5xl font-black text-green-500 tracking-tighter";
                judgeIcon.innerText = "✅";
                judgeDesc.innerText = "Status: Normal";
                btnConfirm.className = "w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-md border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition-all";
            } else {
                judgeTitle.innerText = "NG";
                judgeTitle.className = "text-5xl font-black text-red-500 tracking-tighter";
                judgeIcon.innerText = "⚠️";
                judgeDesc.innerText = "Status: Defect Detected";
                btnConfirm.className = "w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-lg shadow-md border-b-4 border-red-800 active:border-b-0 active:translate-y-1 transition-all";
            }
        }

        // --- ② 確認完了ボタンクリック時（リセット処理） ---
        btnConfirm.addEventListener('click', () => {
            // UIリセット
            viewResult.classList.add('opacity-0');
            
            setTimeout(() => {
                viewResult.classList.add('hidden');
                document.getElementById('judge-icon').classList.add('scale-0');
                
                // ボタン復活
                btnCanSignal.style.display = 'flex';
                
                // インジケータリセット
                canIndicator.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> WAITING FOR CAN';
                canIndicator.className = "text-[10px] font-mono text-red-400 flex items-center gap-1";
                camStatus.innerHTML = '<span class="text-gray-500">● CAMERA READY</span>';
                
                // 写真エリア隠す
                photoStrip.classList.add('hidden');
                instruction.innerText = "Push CAN Button to Start";
                instruction.className = "text-center text-gray-400 text-sm font-bold animate-pulse";

            }, 300); // アニメーション終了後にリセット
        });

        // 起動
        init();
    </script>
</body>
</html>