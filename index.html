<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>港湾AI自動検査システム v7_Tracking</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .scanner-line { position: absolute; width: 100%; height: 4px; background: #eab308; box-shadow: 0 0 15px #eab308; animation: scan 1.5s linear infinite; top: 0; opacity: 0; }
        @keyframes scan { 0% { top: 0; opacity: 0; } 20% { opacity: 1; } 80% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .flash-effect { animation: flash 0.1s ease-out; }
        @keyframes flash { from { background: white; opacity: 0.8; } to { background: transparent; opacity: 0; } }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gray-900 h-screen flex flex-col overflow-hidden font-sans select-none">

    <div id="top-panel" class="h-[30%] bg-white flex flex-col relative z-20 shadow-lg transition-colors duration-500">
        <div class="absolute top-2 left-3 flex gap-2 z-30">
            <div id="ble-badge" class="px-2 py-0.5 rounded text-[10px] font-bold border flex items-center gap-1 bg-white/90 text-blue-600 border-blue-200 transition-all">
                <span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span> BLE接続：確立済み
            </div>
        </div>

        <div id="view-process" class="flex-1 flex flex-col items-center justify-center p-4">
            <div class="text-center mt-4">
                <h1 id="main-status" class="text-2xl font-black text-gray-800 tracking-tight">AI準備中...</h1>
                <p id="sub-status" class="text-xs text-gray-400 font-bold mt-1">カメラと解析モデルを起動しています</p>
            </div>
            <button id="btn-trigger" class="hidden mt-4 bg-slate-800 hover:bg-slate-700 text-white text-sm font-bold py-3 px-8 rounded-full shadow-lg active:scale-95 transition-transform flex items-center gap-2">
                CAN信号受信開始
            </button>
        </div>

        <div id="view-result" class="hidden absolute inset-0 flex flex-col items-center justify-center p-2 animate-fade-in">
            <div class="flex items-center gap-4">
                <span id="res-icon" class="text-5xl bg-white/20 rounded-full p-2">✅</span>
                <div class="text-left">
                    <div id="res-title" class="text-5xl font-black text-white tracking-tighter leading-none">OK</div>
                    <div id="res-desc" class="text-xs text-white/80 font-bold uppercase tracking-widest mt-1">状態正常</div>
                </div>
            </div>
            <button id="btn-confirm" class="mt-4 bg-white text-gray-900 font-black py-2 px-10 rounded-full shadow-lg active:scale-95 transition-transform text-sm border-b-4 border-gray-300 active:border-b-0 active:translate-y-0.5">
                確認完了（次へ）
            </button>
        </div>
    </div>

    <div class="h-[70%] relative bg-black overflow-hidden">
        <video id="webcam" class="absolute inset-0 w-full h-full object-cover opacity-80" autoplay playsinline muted></video>
        <canvas id="overlay" class="absolute inset-0 w-full h-full object-cover"></canvas>
        <div id="scan-bar" class="scanner-line"></div>
        <div id="shutter-overlay" class="absolute inset-0 pointer-events-none"></div>
        
        <div class="absolute inset-0 flex items-center justify-center opacity-20 pointer-events-none">
            <div class="w-32 h-32 border border-white rounded-full"></div>
        </div>

        <div id="photo-container" class="absolute bottom-0 left-0 right-0 h-24 bg-gradient-to-t from-black/90 to-transparent p-2 pb-safe flex gap-2 overflow-x-auto items-end opacity-50 transition-opacity duration-300">
            <div class="text-[9px] text-gray-500 font-bold w-full text-center mb-2">自動連写された画像がここに表示されます</div>
        </div>
    </div>

    <script>
        const topPanel = document.getElementById('top-panel');
        const viewProcess = document.getElementById('view-process');
        const viewResult = document.getElementById('view-result');
        const mainStatus = document.getElementById('main-status');
        const subStatus = document.getElementById('sub-status');
        const btnTrigger = document.getElementById('btn-trigger');
        const btnConfirm = document.getElementById('btn-confirm');
        const bleBadge = document.getElementById('ble-badge');
        const resTitle = document.getElementById('res-title');
        const resIcon = document.getElementById('res-icon');
        const resDesc = document.getElementById('res-desc');
        const video = document.getElementById('webcam');
        const overlay = document.getElementById('overlay');
        const scanBar = document.getElementById('scan-bar');
        const shutterOverlay = document.getElementById('shutter-overlay');
        const photoContainer = document.getElementById('photo-container');

        let model, isModeActive = false, isCapturing = false;
        let audioCtx;

        function playFeedbackSound(type) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode); gainNode.connect(audioCtx.destination);
            if (type === 'OK') {
                oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); oscillator.start(); oscillator.stop(audioCtx.currentTime + 0.2);
            } else if (type === 'NG') {
                oscillator.type = 'sawtooth'; oscillator.frequency.setValueAtTime(220, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); oscillator.start(); oscillator.stop(audioCtx.currentTime + 0.5);
                if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 500]);
            }
        }

        async function init() {
            try {
                model = await cocoSsd.load();
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    mainStatus.innerText = "信号待機中";
                    subStatus.innerText = "マキシブレーキ信号(J1939)の受信を待っています";
                    btnTrigger.classList.remove('hidden');
                    detectFrame();
                };
            } catch (e) {
                mainStatus.innerText = "起動エラー";
                subStatus.innerText = "カメラの許可を確認してください";
            }
        }

        btnTrigger.addEventListener('click', () => {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            isModeActive = true;
            btnTrigger.classList.add('hidden');
            mainStatus.innerText = "作業確認中";
            mainStatus.className = "text-3xl font-black text-blue-600 animate-pulse tracking-tight";
            subStatus.innerText = "対象をスキャン中：カメラを固定してください";
            bleBadge.className = "px-2 py-0.5 rounded text-[10px] font-bold border flex items-center gap-1 bg-gray-200 text-gray-500 border-gray-300";
            bleBadge.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-gray-400"></span> BLE切断：スタンドアロン動作中';
            scanBar.style.opacity = "1";
            video.classList.remove('opacity-80');
            photoContainer.classList.remove('opacity-50');
            photoContainer.innerHTML = '';
        });

        // --- 【改良】検出と枠の描画ロジック ---
        async function detectFrame() {
            if (!video.videoWidth) { requestAnimationFrame(detectFrame); return; }
            overlay.width = video.videoWidth; overlay.height = video.videoHeight;
            const ctx = overlay.getContext('2d');

            // 1. 常に検出を実行
            const predictions = await model.detect(video);
            ctx.clearRect(0, 0, overlay.width, overlay.height);

            // 2. 検出されたものがあれば枠を表示（追従）
            if (predictions.length > 0) {
                const best = predictions[0];
                
                // 追従枠の描画（確信度40%以上で表示）
                if (best.score > 0.4) {
                    ctx.strokeStyle = isCapturing ? "#ef4444" : "#2563eb"; // 撮影中は赤、追従中は青
                    ctx.lineWidth = isCapturing ? 8 : 4;
                    ctx.strokeRect(...best.bbox);

                    // ラベル表示
                    ctx.fillStyle = isCapturing ? "#ef4444" : "#2563eb";
                    ctx.font = "bold 14px sans-serif";
                    const label = `${best.class.toUpperCase()} ${Math.round(best.score * 100)}%`;
                    ctx.fillText(label, best.bbox[0], best.bbox[1] - 10);

                    // 3. 【トリガー条件】「受信中」かつ「未撮影」かつ「高精度(60%以上)」
                    if (isModeActive && !isCapturing && best.score > 0.6) {
                        isModeActive = false; // 重複防止
                        startBurstCapture();
                    }
                }
            }
            requestAnimationFrame(detectFrame);
        }

        async function startBurstCapture() {
            isCapturing = true;
            mainStatus.innerText = "連写撮影中...";
            mainStatus.className = "text-3xl font-black text-red-500 tracking-tight";
            scanBar.style.animationDuration = "0.1s";
            for (let i = 0; i < 10; i++) {
                shutterOverlay.classList.remove('flash-effect');
                void shutterOverlay.offsetWidth;
                shutterOverlay.classList.add('flash-effect');
                addThumbnail(i);
                await new Promise(r => setTimeout(r, 100));
            }
            isCapturing = false; // 枠の色を戻す
            mainStatus.innerText = "AI判定中...";
            mainStatus.className = "text-3xl font-black text-gray-800 tracking-tight";
            setTimeout(showResult, 1000);
        }

        function addThumbnail(i) {
            const cvs = document.createElement('canvas');
            cvs.width = 160; cvs.height = 120;
            cvs.getContext('2d').drawImage(video, 0, 0, 160, 120);
            const img = document.createElement('img');
            img.src = cvs.toDataURL('image/jpeg');
            img.className = "h-full w-24 object-cover rounded border border-white/50 shadow-sm";
            photoContainer.insertBefore(img, photoContainer.firstChild);
        }

        function showResult() {
            viewProcess.classList.add('hidden');
            viewResult.classList.remove('hidden');
            const isOk = Math.random() > 0.3;
            if (isOk) {
                playFeedbackSound('OK');
                topPanel.className = "h-[30%] bg-green-500 flex flex-col relative z-20 shadow-lg transition-colors duration-500";
                resTitle.innerText = "OK"; resIcon.innerText = "✅"; resDesc.innerText = "状態正常";
            } else {
                playFeedbackSound('NG');
                topPanel.className = "h-[30%] bg-yellow-400 flex flex-col relative z-20 shadow-lg transition-colors duration-500 text-gray-900";
                resTitle.innerText = "NG"; resIcon.innerText = "⚠️"; resDesc.innerText = "異常あり：再確認してください";
            }
        }

        btnConfirm.addEventListener('click', () => {
            topPanel.className = "h-[30%] bg-white flex flex-col relative z-20 shadow-lg transition-colors duration-500";
            viewResult.classList.add('hidden'); viewProcess.classList.remove('hidden');
            bleBadge.className = "px-2 py-0.5 rounded text-[10px] font-bold border flex items-center gap-1 bg-white/90 text-blue-600 border-blue-200 transition-all";
            bleBadge.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span> BLE接続：確立済み';
            mainStatus.innerText = "信号待機中"; mainStatus.className = "text-2xl font-black text-gray-800 tracking-tight";
            btnTrigger.classList.remove('hidden');
            video.classList.add('opacity-80');
            photoContainer.classList.add('opacity-50');
            photoContainer.innerHTML = '<div class="text-[9px] text-gray-500 font-bold w-full text-center mb-2">自動連写された画像がここに表示されます</div>';
        });

        init();
    </script>
</body>
</html>
